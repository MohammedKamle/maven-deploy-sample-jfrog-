name: Build and Publish with JFrog CLI

on:
  push:
    branches: ["main"]
  # 1. ADD PULL REQUEST TRIGGER HERE
  pull_request:
    branches: ["main"]

jobs:
  # NEW JOB: Dedicated Frogbot Scan job for PRs and Pushes
  frogbot_scan:
    runs-on: ubuntu-latest
    environment: frogbot
    # The 'if' condition is not strictly necessary here since the 'on' trigger
    # already defines when this job runs, but it's good practice if you were
    # using a single job for everything. Frogbot action is smart enough.
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # Important: Fetch full history for accurate scanning, especially for PRs
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # --- FROGBOT STEP (runs on push/pull_request to main) ---
      - name: Run Frogbot Scan
        uses: jfrog/frogbot@v2
        env:
          # The secrets you configured in Step 1
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
          JF_GIT_TOKEN: ${{ secrets.JF_GIT_TOKEN }}
      # --- END OF FROGBOT STEP ---

  # ORIGINAL BUILD JOB: Only runs on 'push' to main
  build:
    runs-on: ubuntu-latest
    environment: frogbot
    # Optional: Ensure the build job only runs after the scan passes (recommended)
    needs: frogbot_scan
    # The job inherits the 'push' trigger from the 'on' section, but PRs are now handled
    # by 'frogbot_scan' job, which is then a prerequisite for this.
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # Install JFrog CLI
      - name: Install JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4

      # 1. Configure JFrog CLI Authentication
      - name: Configure JFrog CLI
        run: |
          jf config add myjf \
            --url="$JF_URL" \
            --user="mohammedk@jfrog.com" \
            --access-token="$JF_ACCESS_TOKEN" \
            --interactive=false
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      # 2. Configure Maven Repositories (The Fix)
      - name: Configure Maven for JFrog
        run: |
          jf mvnc --global \
            --server-id-resolve=myjf \
            --server-id-deploy=myjf \
            --repo-resolve-releases=mdk-remote \
            --repo-resolve-snapshots=mdk-remote \
            --repo-deploy-releases=$JF_REPO \
            --repo-deploy-snapshots=$JF_REPO
        env:
          JF_REPO: ${{ secrets.JF_REPO }}

      # Set build name and number
      - name: Set build variables
        run: |
          export BUILD_NAME="gh-actions-build"
          export BUILD_NUMBER="${{ github.run_number }}"
          echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV

      # 3. Maven Build & Deploy
      - name: Maven Build and Deploy
        run: |
          jf mvn clean deploy \
            --build-name="$BUILD_NAME" \
            --build-number="$BUILD_NUMBER"

      # Collect environment info for build-info
      - name: Collect environment variables
        run: |
          jf rt bce "$BUILD_NAME" "$BUILD_NUMBER"

      # Publish build-info to Artifactory
      - name: Publish build info
        run: |
          jf rt bp "$BUILD_NAME" "$BUILD_NUMBER"