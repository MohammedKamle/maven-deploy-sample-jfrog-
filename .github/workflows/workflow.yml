name: Build and Publish with JFrog CLI

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # Install JFrog CLI
      - name: Install JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4

      # 1. Configure JFrog CLI Authentication
      - name: Configure JFrog CLI
        run: |
          jf config add myjf \
            --url="$JF_URL" \
            --access-token="$JF_ACCESS_TOKEN" \
            --interactive=false
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      # 2. Configure Maven Repositories (The Fix)
      # This maps your Maven build to the specific Artifactory repository defined in secrets
      - name: Configure Maven for JFrog
        run: |
          jf mvnc --global \
            --server-id-resolve=myjf \
            --server-id-deploy=myjf \
            --repo-resolve-releases=$JF_REPO \
            --repo-resolve-snapshots=$JF_REPO \
            --repo-deploy-releases=$JF_REPO \
            --repo-deploy-snapshots=$JF_REPO
        env:
          JF_REPO: ${{ secrets.JF_REPO }}

      # Set build name and number
      - name: Set build variables
        run: |
          export BUILD_NAME="gh-actions-build"
          export BUILD_NUMBER="${{ github.run_number }}"
          echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV

      # 3. Maven Build & Deploy (Replaces 'mvn package' and 'jf rt u')
      # 'jf mvn' wraps the standard maven command but intercepts the deploy phase
      # to ensure artifacts go to the correct path in Artifactory.
      - name: Maven Build and Deploy
        run: |
          jf mvn "clean deploy" \
            --build-name="$BUILD_NAME" \
            --build-number="$BUILD_NUMBER"

      # Collect environment info for build-info (Optional, jf mvn usually captures this too)
      - name: Collect environment variables
        run: |
          jf rt bce "$BUILD_NAME" "$BUILD_NUMBER"

      # Publish build-info to Artifactory
      - name: Publish build info
        run: |
          jf rt bp "$BUILD_NAME" "$BUILD_NUMBER"